# Documentation at https://goreleaser.com

# This file is a template and expressions such as __PROTOC_VERSION__ are replaced
# with environment variables such as $PROTOC_VERSION before usage.

# https://goreleaser.com/customization/build/
builds:
  - binary: bin/protocurl
    dir: src
    env:
      - CGO_ENABLED=0
    goos:
      - linux
      - windows
      - darwin
    ignore:
      # This combination is not pre-built by Google Protobuf
      - goos: windows
        goarch: arm64


# https://goreleaser.com/customization/archive/
archives:
  - format: zip
    files:
      # NOTE: These files are listed again in the packages below. Keep them synced!
      # binary is added implicitly
      - README.md
      - LICENSE.md
      # copy protoc binaries and their .proto files previously downloaded
      - src: 'release/tmp/protoc-__PROTO_VERSION__-{{ .Os }}-{{ .Arch }}/bin'
        dst: 'protocurl-internal/bin'
        strip_parent: true # avoids, that protoc is copied into protocurl-internal/bin/release/tmp/.../bin
      - src: 'release/tmp/protoc-__PROTO_VERSION__-{{ .Os }}-{{ .Arch }}/include/google/protobuf'
        dst: 'protocurl-internal/include/google/protobuf'
        strip_parent: true

# Linux packages
nfpms:
  - package_name: protocurl
    description: |-
      protoCURL is cURL for Protobuf:
      The command-line tool for interacting with Protobuf over
      HTTP REST endpoints using human-readable text formats.

    homepage: https://github.com/qaware/protocurl
    license: MIT
    maintainer: GollyTicker <golly.ticker@gmail.com>
    priority: extra

    formats:
      - apk
      - deb
    dependencies:
      - curl
    suggests:
      - curl

    overrides:
      # protoc is compiled against glibc whereas alpine uses musl.
      # See: https://stackoverflow.com/a/64447927
      apk:
        dependencies:
          - curl
          - gcompat

    # adds the ./bin/protocurl
    bindir: /opt/protocurl

    # GoReleaser will automatically add the binaries.
    contents:
      - src: /opt/protocurl/bin/protocurl
        dst: /usr/bin/protocurl
        type: "symlink"

      # NOTE: These files are listed again in the archives above. Keep them synced!
      # binary is added implicitly
      - src: README.md
        dst: /opt/protocurl/README.md
      - src: LICENSE.md
        dst: /opt/protocurl/LICENSE.md
      # copy protoc binaries and their .proto files previously downloaded
      - src: 'release/tmp/protoc-__PROTO_VERSION__-{{ .Os }}-{{ .Arch }}/bin'
        dst: '/opt/protocurl/protocurl-internal/bin'
      - src: 'release/tmp/protoc-__PROTO_VERSION__-{{ .Os }}-{{ .Arch }}/include/google/protobuf'
        dst: '/opt/protocurl/protocurl-internal/include/google/protobuf'


brews:
  - name: protocurl

    # GitHub/GitLab repository to push the formula to
    tap:
      owner: GollyTicker
      name: homebrew-tap

      # Optionally a branch can be provided.
      # Defaults to the default repository branch.
      branch: main
      # todo. use current branch here.

    # Template for the url which is determined by the given Token (github, gitlab or gitea)
    #
    # Default depends on the client.
    url_template: "http://github.mycompany.com/foo/bar/releases/{{ .Tag }}/{{ .ArtifactName }}"

    # Allows you to set a custom download strategy. Note that you'll need
    # to implement the strategy and add it to your tap repository.
    # Example: https://docs.brew.sh/Formula-Cookbook#specifying-the-download-strategy-explicitly
    # Default is empty.
    download_strategy: CurlDownloadStrategy

    # Allows you to add a custom require_relative at the top of the formula template
    # Default is empty
    custom_require: custom_download_strategy

    # Git author used to commit to the repository.
    # Defaults are shown.
    commit_author:
      name: goreleaserbot
      email: goreleaser@carlosbecker.com

    # The project name and current git tag are used in the format string.
    commit_msg_template: "Brew formula update for {{ .ProjectName }} version {{ .Tag }}"

    # Folder inside the repository to put the formula.
    # Default is the root folder.
    folder: Formula

    # Caveats for the user of your binary.
    # Default is empty.
    caveats: "How to use this binary"

    # Your app's homepage.
    # Default is empty.
    homepage: "https://example.com/"

    # Template of your app's description.
    # Default is empty.
    description: "Software to create fast and easy drum rolls."

    license: MIT

    # Setting this will prevent goreleaser to actually try to commit the updated
    # formula - instead, the formula file will be stored on the dist folder only,
    # leaving the responsibility of publishing it to the user.
    # If set to auto, the release will not be uploaded to the homebrew tap
    # in case there is an indicator for prerelease in the tag e.g. v1.0.0-rc1
    # Default is false.
    skip_upload: false
    # todo. this should be set to auto

    dependencies:
      - name: curl

release:
  # If set to auto, will mark the release as not ready for production
  # in case there is an indicator for this in the tag e.g. v1.0.0-rc1
  prerelease: auto


checksum:
  name_template: 'checksums.txt'

snapshot:
  name_template: "{{ .Version }}-dev"

changelog:
  sort: asc
  filters:
    exclude:
      - '^docs:'
      - '^test:'
